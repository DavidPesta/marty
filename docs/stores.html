<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Stores | marty.js</title>
  <meta name="viewport" content="width=device-width">

  <link rel="shortcut icon" href="/favicon.ico?v=1" type="image/x-icon">

  <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/css/codemirror.css">
  <link rel="stylesheet" type="text/css" href="/css/docs.css">

  <script type="text/javascript" src="/js/codemirror.js"></script>
</head>
<body>
  <header class="navbar navbar-static-top bs-docs-nav" id="top" role="banner">
    <div class="container">
      <div class="navbar-header">
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" class="navbar-brand">marty.js</a>
      </div>
      <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
        <ul class="nav navbar-nav">
          <li>
            <a href="/getting-started/">Getting started</a>
          </li>
          <li>
            <a href="/docs">Documentation</a>

            <ul class="nav sub-nav visible-xs-block">
              
              
              
                
                  
                
              
                
                  
                
              
                
                  
                    
                    <li><a href="/docs/index.html">Overview</a></li>
                    
                  
                
              
                
                  
                    
                    <li class="active"><a href="/docs/stores.html" class="active">Stores</a></li>
                    
                  
                
              
                
                  
                    
                    <li><a href="/docs/actionCreators.html">Action Creators</a></li>
                    
                  
                
              
                
                  
                    
                    <li><a href="/docs/stateMixin.html">State mixin</a></li>
                    
                  
                
              
                
                  
                    
                    <li><a href="/docs/httpApi.html">HTTP API</a></li>
                    
                  
                
              
                
                  
                    
                    <li><a href="/docs/constants.html">Constants</a></li>
                    
                  
                
              
                
                  
                    
                    <li><a href="/docs/dispatcher.html">Dispatcher</a></li>
                    
                  
                
              
              
              
            </ul>
          </li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="http://github.com/jhollingworth/marty">
              <i class="fa fa-github"></i>
              Github
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </header>
  <div class="bs-docs-header" id="content"  style="background-color: #1DACA8">
  <div class="container">
    <h1>Stores</h1>
    <p></p>
  </div>
</div>
<div class="container bs-docs-container">
  <div class="row">
    <div class="col-md-9" role="main">
      <div class="bs-docs-section">
        <p>Stores hold information about a domain. That domain could be a collection of entities (Like a <a href="http://backbonejs.org/#Collection">Backbone Collection</a>) or it could be some information about something specific (Like a <a href="http://backbonejs.org/#Model">Backbone Model</a>). It is responsible for processing actions from the <a href="/docs/dispatcher.html">dispatcher</a>, updating its own state and notifying interested parties when its state changes.</p>

<p>The store should be the <strong>only</strong> place where your applications state changes. If your views want to update its state, it should call an <a href="/docs/actionCreators.html">action creator</a> which dispatches an action that stores listen to and update themselves and then notify the views about their new state.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">UsersStore</span> <span class="o">=</span> <span class="nx">Marty</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'Users'</span><span class="p">,</span>
  <span class="na">handlers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">addUser</span><span class="p">:</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">RECEIVE_USER</span>
  <span class="p">},</span>
  <span class="na">getInitialState</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{};</span>
  <span class="p">},</span>
  <span class="nx">addUser</span><span class="err">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hasChanged</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">getUser</span><span class="err">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
      <span class="na">id</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span>
      <span class="na">locally</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
      <span class="p">},</span>
      <span class="nx">remotely</span><span class="err">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">UserAPI</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<p>A store is a singleton which is created using <a href="#createStore"><code>Marty.createStore</code></a>. When the store is created it will call <a href="#getInitialState"><code>getInitialState</code></a> which should return an object that all the stores state will live in. This state is accessible by calling <code>this.state</code>.</p>

<p>When an action is dispatched, the store will check its <a href="/docs/stores.html#handlers"><code>handlers</code> hash</a> to see if the store has a handler for the actions type. If it does it will call that handler, passing in the actions data. If the handler updates the stores state state, it can call <a href="#hasChanged"><code>hasChanged</code></a> which will notify any listening views of its new state.</p>

<p>If your view needs some data, it should request it from the relevant store. The store is responsible for sourcing it, either locally or from the server. The <a href="/docs/stores.html#fetch">fetch</a> API helps simplify handling async operations.</p>

<h2 id="api">API</h2>

<h3 id="createStore">createStore(props)</h3>

<p>To create a new store, you call <code>Marty.createStore</code> passing in a set of instance properties. It returns a singleton store which is listening to the dispatcher.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">UsersStore</span> <span class="o">=</span> <span class="nx">Marty</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'Users'</span><span class="p">,</span>
  <span class="na">handlers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">addUser</span><span class="p">:</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">RECEIVE_USER</span>
  <span class="p">},</span>
  <span class="na">addUser</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hasChanged</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">getInitialState</span><span class="err">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[];</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<h3 id="name">name</h3>

<p>An (optional) display name for the store. Used for richer debugging.</p>

<h3 id="handlers">handlers</h3>

<p>The <code>handlers</code> property is used to define which handlers should be called when an action is dispatched. The key is the name of the handler and value is an <a href="#action-predicates">action predicate</a>.</p>

<p>When invoked the handlers arguments are <a href="/docs/actionCreators.html#dispatch">the arguments passed to the dispatcher</a>. The original action is available by calling <code>this.action</code>.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">UsersStore</span> <span class="o">=</span> <span class="nx">Marty</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="na">handlers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">addUser</span><span class="p">:</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">RECEIVE_USER</span>
  <span class="p">},</span>
  <span class="na">addUser</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">action</span><span class="p">)</span> <span class="c1">// { type: 'RECEIVE_USER', arguments: [{ name: ...}] }</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<h4 id="action-predicates">Action predicates</h4>

<p>An action predicate can either be a single value or an array of either action types (i.e. a strong) or a <a href="http://underscorejs.org/#findWhere">where query</a>. Some examples of action predicates:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">UsersStore</span> <span class="o">=</span> <span class="nx">Marty</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="na">handlers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">foo</span><span class="p">:</span> <span class="s1">'ADD_USER'</span><span class="p">,</span>
    <span class="na">bar</span><span class="p">:</span> <span class="p">[</span><span class="s1">'ADD_USER'</span><span class="p">,</span> <span class="s1">'UPDATE_USER'</span><span class="p">],</span>
    <span class="na">baz</span><span class="p">:</span> <span class="p">{</span> <span class="na">source</span><span class="p">:</span> <span class="s1">'VIEW'</span> <span class="p">},</span>
    <span class="na">bam</span><span class="p">:</span> <span class="p">[{</span> <span class="na">source</span><span class="p">:</span> <span class="s1">'VIEW'</span> <span class="p">},</span> <span class="s1">'USER_DELETED'</span><span class="p">]</span>
  <span class="p">},</span>
  <span class="c1">// called when action.type == 'ADD_USER'</span>
  <span class="na">foo</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="p">..</span> <span class="p">},</span>

  <span class="c1">// called when action.type == 'ADD_USER' || action.type ==  'UPDATE_USER'</span>
  <span class="nx">bar</span><span class="err">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="p">..</span> <span class="p">},</span>

  <span class="c1">// called when action.source == 'VIEW'</span>
  <span class="nx">baz</span><span class="err">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="p">..</span> <span class="p">},</span>

  <span class="c1">// called when action.source == 'VIEW' || action.type ==  'USER_DELETED'</span>
  <span class="nx">bam</span><span class="err">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="p">..</span> <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<h4 id="rollback">Rollback</h4>

<p>There are a number of cases where it would be useful to be able to rollback an action (e.g. if you&#39;ve optimistically added an entity to your locally store but the associated request to the server failed).</p>

<p>To provide a rollback to an action handler, simply return a function from the action handler. If an <a href="/docs/actionCreators.html#dispatch">action is rolled back</a>, the function you return will be called.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">UsersStore</span> <span class="o">=</span> <span class="nx">Marty</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="na">handlers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">addUser</span><span class="p">:</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">RECEIVE_USER</span>
  <span class="p">},</span>
  <span class="na">addUser</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hasChanged</span><span class="p">();</span>

    <span class="k">return</span> <span class="kd">function</span> <span class="nx">rollback</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">user</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">hasChanged</span><span class="p">();</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<h3 id="getInitialState">getInitialState()</h3>

<p><code>getInitialState</code> is called when the store is first instantiated. It expects you to pass an object back which represents the stores state. The value you return will subsequently be available from the <a href="#state">state</a> property.</p>

<p>If you do not implement getInitialState or you do not return anything then the default state is an empty object literal (<code>{}</code>).</p>

<h3 id="state">state</h3>

<p>The state property holds the current state of the store. You can get the state by calling <code>this.state</code> or <code>this.getState()</code>.</p>

<p>If you want to change the state to a new instance (or if you are using <a href="immutable">immutable data collections</a>) you can set the states value or call <code>this.setState(state)</code></p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">addUsers</span><span class="err">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">users</span><span class="p">);</span>

  <span class="c1">// or</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">users</span><span class="p">));</span>
<span class="p">}</span></code></pre></div>

<p>If the new state does not equal the current state then <a href="#hasChanged">hasChanged</a> will be called after updating the stores state.</p>

<h3 id="addChangeListener">addChangeListener(callback, [context])</h3>

<p>If you want to be notified of changes to a store, you can register a callback by calling <code>Store.addChangeListener</code>. You can optionally pass the functions context as a second argument.</p>

<p>Once registered, the store will invoke your callback anytime the store changes passing the state and the store as the two arguments.</p>

<p>addChangeListener will return a disposable object. If you want to stop listening to the store, you can call <code>dispose</code> on the object.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">listener</span> <span class="o">=</span> <span class="nx">UserStore</span><span class="p">.</span><span class="nx">addChangeListener</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">store</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'state'</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'from'</span><span class="p">,</span> <span class="nx">store</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="p">},</span> <span class="k">this</span><span class="p">);</span>

<span class="nx">listener</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span></code></pre></div>

<h3 id="hasChanged">hasChanged()</h3>

<p>Calls any <a href="#addChangeListener">registered callbacks</a>.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">UsersStore</span> <span class="o">=</span> <span class="nx">Marty</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="na">handlers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">addUser</span><span class="p">:</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">RECEIVE_USER</span>
  <span class="p">},</span>
  <span class="na">addUser</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hasChanged</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<h3 id="fetch">fetch(options)</h3>

<p>When requesting data from a store we should assume that it might require an async operation. <code>Store#fetch</code> provides a simple syntax that allows you to encapsulate that asynchronicity in a flux way. The <code>fetch</code> function allows you to specify how to get the state locally and remotely and returns an object that represents the current state of that request.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">UsersStore</span> <span class="o">=</span> <span class="nx">Marty</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="na">getUser</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
      <span class="na">id</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span>
      <span class="na">locally</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
      <span class="p">},</span>
      <span class="na">remotely</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">UserAPI</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">UsersStore</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="mi">123</span><span class="p">).</span><span class="nx">when</span><span class="p">({</span>
  <span class="na">pending</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"pending"</span><span class="o">/&gt;</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">failed</span><span class="err">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"error"</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">;
</span>  <span class="p">},</span>
  <span class="nx">done</span><span class="err">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"user"</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">;
</span>  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<h4>Options</h4>

<table class="table table-bordered table-striped">
  <thead>
   <tr>
     <th style="width: 100px;">Name</th>
     <th style="width: 100px;">type</th>
     <th style="width: 50px;">required</th>
     <th>description</th>
   </tr>
  </thead>
  <tbody>
   <tr>
     <td>id</td>
     <td>number | string | object</td>
     <td>true</td>
     <td>Uniquely identifies the bit of state you are fetching. Only one request for a given Id can be in progress at any time. If another request is in progress then a pending fetch result is returned</td>
   </tr>
   <tr>
     <td>locally</td>
     <td>function</td>
     <td>true</td>
     <td>Should try and fetch from the local state. If it returns a value then an done fetch result will be returned immediately</td>
   </tr>
   <tr>
     <td>remotely</td>
     <td>function</td>
     <td>false</td>
     <td>
     If ``locally`` did not return a value then then ``remotely`` is invoked. When ``remotely`` has finished then ``locally`` will be reinvoked and should contain now contain the state. If ``remotely`` returns a promise then ``locally`` will be called if the promise is fulfilled</td>
   </tr>
   <tr>
     <td>dependsOn</td>
     <td>fetch result | array of fetch results</td>
     <td>false</td>
     <td>If a fetch depends on some other state being there already you can pass in their fetch results. It will only try and start fetching the data when all dependencies are done.</td>
   </tr>
   <tr>
     <td>cacheError</td>
     <td>boolean</td>
     <td>false</td>
     <td>If true (default) then if an error is thrown at any point during a fetch then that error is cached and returned immediately instead.</td>
   </tr>
  </tbody>
</table>

<p>Often you&#39;re only concerned with fetching locally and remotely so you use the second function signature <code>fetch(id, locally, remotely)</code>:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">UsersStore</span> <span class="o">=</span> <span class="nx">Marty</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="na">getUser</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span>
      <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
      <span class="p">},</span>
      <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">UserAPI</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<h4>Fetch Result</h4>

<p>Fetch returns a result object that repesents the current state of the fetch. It has a status which can be either <strong>PENDING</strong>, <strong>DONE</strong> OR <strong>ERROR</strong>. You can get the status by accessing <code>fetch.status</code> or with the helpers <code>fetch.pending</code>, <code>fetch.failed</code> or <code>fetch.done</code>.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">UserStore</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="c1">// =&gt; PENDING</span></code></pre></div>

<p>If the fetch has an error, then the error is accessible at <code>result#error</code></p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">failed</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'failed to get user'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<p>If the fetch is done, then the result is accessible at <code>result#result</code></p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'got user'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<p>If you start a new fetch then the store will notify any listeners when the fetch&#39;s status has changed.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">UserStore</span><span class="p">.</span><span class="nx">addChangeListener</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">UserStore</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<p>The result offers the helper function <code>when(statusHandlers)</code> for handling each of the status</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">component</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">when</span><span class="p">({</span>
  <span class="na">pending</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">Loading</span> <span class="o">/&gt;</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">failed</span><span class="err">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">ErrorPage</span> <span class="nx">error</span><span class="o">=</span><span class="p">{</span><span class="nx">error</span><span class="p">}</span> <span class="sr">/&gt;</span><span class="err">;
</span>  <span class="p">},</span>
  <span class="nx">done</span><span class="err">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"user"</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">;
</span>  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<h3 id="fetch_pending">fetch.pending()</h3>

<p>Returns a pending fetch result</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">Store</span><span class="p">.</span><span class="nx">fetch</span><span class="p">.</span><span class="nx">pending</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">fetch</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="c1">// PENDING</span></code></pre></div>

<h3 id="fetch_failed">fetch.failed(error)</h3>

<p>Returns a failed fetch result</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">Store</span><span class="p">.</span><span class="nx">fetch</span><span class="p">.</span><span class="nx">failed</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">fetch</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">fetch</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="c1">// FAILED, { ... }</span></code></pre></div>

<h3 id="fetch_done">fetch.done(result)</h3>

<p>Returns a done fetch result</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">Store</span><span class="p">.</span><span class="nx">fetch</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">fetch</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">fetch</span><span class="p">.</span><span class="nx">result</span><span class="p">)</span> <span class="c1">// DONE, { ... }</span></code></pre></div>

<h3 id="waitFor">waitFor(*stores)</h3>

<p>If an action handler is dependant on another store having already processed the action they can wait for those stores to finish processing by calling <code>waitFor</code>. If you call <code>waitFor</code> with the stores you wish to wait for (or pass an array), it will stop execution of the current action handler, process all dependent action handlers and then continue execution of the original action handler.</p>

<p>You can also pass an array of dispatch tokens to waitFor.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">UsersStore</span> <span class="o">=</span> <span class="nx">Marty</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="na">handlers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">addUser</span><span class="p">:</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">RECEIVE_USER</span>
  <span class="p">},</span>
  <span class="na">addUser</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">(</span><span class="nx">FooStore</span><span class="p">,</span> <span class="nx">BarStore</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hasChanged</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<h3 id="#dispatchToken">dispatchToken</h3>

<p>Dispatch token that is returned from <a href="http://facebook.github.io/flux/docs/dispatcher.html#api"><code>Dispatcher.register()</code></a>. Used by <a href="#waitFor"><code>waitFor()</code></a>.</p>

<h2 id="immutable">Immutable data collections</h2>

<p>Within a Flux application you want the stores to be the <strong>only</strong> place you can change state. This can be very difficult to achieve using the in built Javascript collections since they are mutable. This can make it very difficult to debug issues since any piece of code that touches that collection could be the cause.</p>

<p>The solution this is to use immutable data collections like <a href="http://facebook.github.io/immutable-js/">immutable.js</a> or <a href="http://swannodette.github.io/mori/">mori</a>. Operations on immutable data structures do mutate the instance itself but rather return a new instance with is the result of the mutation.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="nx">Immutable</span><span class="p">.</span><span class="nx">List</span><span class="p">.</span><span class="nx">of</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">users2</span> <span class="o">=</span> <span class="nx">users</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">"bar"</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">users</span><span class="p">)</span> <span class="c1">// ["foo"]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">users2</span><span class="p">)</span> <span class="c1">// ["foo", "bar"]</span></code></pre></div>

<p>Using immutable data collections help you sleep soundly with knowledge that nothing outside of stores will be able to change its state.</p>

<p>While immutable data collections are not required, we try to make it as easy to use as possible. For example, you can simple call this.state with the mutated collection and internally it will check if the collection has changed and handle notifying and listeners.</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">UsersStore</span> <span class="o">=</span> <span class="nx">Marty</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="na">handlers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">addUser</span><span class="p">:</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">RECEIVE_USER</span>
  <span class="p">},</span>
  <span class="na">getInitialState</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Immutable</span><span class="p">.</span><span class="nx">List</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">addUser</span><span class="err">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></div>

<h2 id="further-reading">Further reading</h2>

<ul>
<li><a href="http://facebook.github.io/flux/docs/overview.html#stores">Original article about Flux</a></li>
</ul>

      </div>
    </div>
    <div class="col-md-3">
      <div class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix-top" role="complementary">
        <ul class="nav bs-docs-sidenav">
          
          
          
            
              
            
          
            
              
            
          
            
              
                
                <li><a href="/docs/index.html">Overview</a></li>
                
              
            
          
            
              
                
                <li class="active"><a href="/docs/stores.html" class="active">Stores</a></li>
                
              
            
          
            
              
                
                <li><a href="/docs/actionCreators.html">Action Creators</a></li>
                
              
            
          
            
              
                
                <li><a href="/docs/stateMixin.html">State mixin</a></li>
                
              
            
          
            
              
                
                <li><a href="/docs/httpApi.html">HTTP API</a></li>
                
              
            
          
            
              
                
                <li><a href="/docs/constants.html">Constants</a></li>
                
              
            
          
            
              
                
                <li><a href="/docs/dispatcher.html">Dispatcher</a></li>
                
              
            
          
          
          
        </ul>
      </div>
    </div>
</div>

  <footer class="bs-docs-footer" role="contentinfo">
    <div class="container">
      <p>Code licensed under <a href="https://github.com/jhollingworth/marty/blob/master/LICENSE" target="_blank">MIT</a>, documentation under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</p>
      <ul class="bs-docs-footer-links muted">
        <li>v0.6.0</li>
        <li>·</li>
        <li><a href="https://github.com/jhollingworth/marty">GitHub</a></li>
        <li>·</li>
        <li><a href="https://github.com/jhollingworth/marty/issues">Issues</a></li>
        <li>·</li>
        <li><a href="https://github.com/jhollingworth/marty/releases">Releases</a></li>
      </ul>
    </div>
  </footer>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56575082-1', 'auto');
    ga('send', 'pageview');

  </script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="/js/headings.js"></script>
  <script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
</body>
</html>